<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade Haven â€¢ Testnet Payment</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f7f7fb;margin:0}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:42px;line-height:1.15;margin:0 0 8px}
    p{color:#555}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:24px;margin-top:24px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:14px;color:#444;margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:12px;font-size:16px}
    button{width:100%;padding:14px 18px;border:0;border-radius:12px;background:#6b2ae6;color:#fff;font-weight:700;font-size:16px;margin-top:14px}
    .muted{color:#777;font-size:13px;margin-top:8px}
    .status{position:fixed;bottom:10px;left:10px;right:10px;max-width:980px;margin:0 auto;background:#111;color:#fff;padding:10px 12px;border-radius:10px;font-size:12px;opacity:.95;z-index:9999;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thrive with Pi Across Africa & Beyond</h1>
    <p>Do a quick <b>test payment</b> to confirm your app is wired to the Pi Network SDK.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Amount (Ï€)</label>
          <input id="amount" value="0.001" inputmode="decimal" />
        </div>
        <div>
          <label>Purpose</label>
          <select id="purpose">
            <option>Test payment</option>
            <option>Listing boost</option>
            <option>Verification</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Memo (optional)</label>
        <input id="memo" placeholder="e.g., QA check from Paynekilla" />
      </div>

      <button id="pay-btn" type="button">âš¡ Send Test Payment</button>
      <button id="selftest-btn" type="button" style="background:#0ea5e9">ðŸ§ª Run Selfâ€‘Test</button>
      <div class="muted">Works only in Pi Browser â€¢ Safe test: no mainnet funds are used</div>
    </div>
  </div>

  <div id="status" class="status">Loadingâ€¦</div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
  (function(){
    const statusEl = document.getElementById('status');
    const say = (m)=>{ statusEl.textContent = m; };
    const sayMore = (m)=>{ statusEl.textContent += "\\n" + m; };

    const btn = document.getElementById('pay-btn');
    const testBtn = document.getElementById('selftest-btn');

    // ---------- Common helpers ----------
    function ensurePi() {
      if (!window.Pi) { say("âŒ Pi SDK not loaded. Open this page inside Pi Browser."); return false; }
      return true;
    }
    async function auth() {
      try {
        const me = await Pi.authenticate(['payments'], (p)=>console.log('incomplete payment:', p));
        sayMore('ðŸ” Auth OK as ' + (me?.username || 'user'));
        return true;
      } catch(e) {
        sayMore('âŒ Auth failed: ' + (e?.message || e));
        return false;
      }
    }
    async function checkBackend() {
      try {
        const r = await fetch('/api/pi/approve', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
        const j = await r.json();
        if (r.status === 400 && j?.error?.includes('paymentId')) {
          sayMore('ðŸ›°ï¸ Backend OK (approve endpoint reachable).');
          return true;
        } else {
          sayMore('âš ï¸ Backend responded: ' + r.status + ' ' + JSON.stringify(j));
          return false;
        }
      } catch(e) {
        sayMore('âŒ Backend unreachable: ' + (e?.message || e));
        return false;
      }
    }

    // ---------- Self-Test button ----------
    testBtn.addEventListener('click', async () => {
      statusEl.textContent = 'ðŸ§ª Selfâ€‘Test startingâ€¦';
      if (!ensurePi()) return;

      Pi.init({ version: "2.0", sandbox: true });
      sayMore('Pi SDK initialized (testnet).');

      const okAuth = await auth();
      if (!okAuth) return;

      const okBack = await checkBackend();
      if (!okBack) return;

      sayMore('âœ… Selfâ€‘Test passed. You can try the payment now.');
      alert('Selfâ€‘Test passed. Now tap "Send Test Payment".');
    });

    // ---------- Payment button ----------
    btn.addEventListener('click', async () => {
      statusEl.textContent = 'âš¡ Payment startingâ€¦';
      if (!ensurePi()) { alert('Open in Pi Browser'); return; }

      Pi.init({ version: "2.0", sandbox: true });
      sayMore('Pi SDK initialized (testnet).');

      const okAuth = await auth();
      if (!okAuth) { alert('Auth failed â€” check Dev Portal URL/origin matches exactly.'); return; }

      const amount = Number((document.getElementById('amount').value || '0.001'));
      const memo   = (document.getElementById('memo').value || 'QA test');

      try {
        await Pi.createPayment({ amount, memo, metadata:{} }, {
          onReadyForServerApproval: async (paymentId) => {
            sayMore('Approving on serverâ€¦ ' + paymentId);
            await fetch('/api/pi/approve', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            sayMore('Completing on serverâ€¦ txid=' + txid);
            await fetch('/api/pi/complete', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: (id)=>{ sayMore('âŒ Payment canceled'); alert('Payment canceled'); },
          onError:  (err,id)=>{ sayMore('âš ï¸ Pi error: ' + err); alert('Pi error: ' + err); },
        });
        sayMore('âœ… Payment flow finished'); alert('Payment flow finished');
      } catch(e) {
        sayMore('âŒ Payment failed: ' + (e?.message || e));
        alert('Payment failed: ' + (e?.message || e));
      }
    });

    // Initial hint
    say('Ready. Use ðŸ§ª Selfâ€‘Test first, then âš¡ Send Test Payment.');
  })();

  // Catch any silent script errors
  window.addEventListener('error', e => {
    const el = document.getElementById('status');
    if (el) el.textContent += "\\nJS error: " + e.message;
    alert('JS error: ' + e.message);
  });
  </script>
</body>
</html>
