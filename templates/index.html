<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade Haven • Testnet Payment</title>
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f7f7fb;margin:0;padding:0}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:48px;line-height:1.1;margin:0 0 8px}
    p{color:#555}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:24px;margin-top:24px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:14px;color:#444;margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:12px;font-size:16px}
    button{width:100%;padding:14px 18px;border:0;border-radius:12px;background:#6b2ae6;color:#fff;font-weight:700;font-size:16px;margin-top:14px}
    .muted{color:#777;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thrive with Pi Across Africa & Beyond</h1>
    <p>Do a quick <b>test payment</b> to confirm your app is wired to the Pi Network SDK.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Amount (π)</label>
          <input id="amount" value="0.001" inputmode="decimal" />
        </div>
        <div>
          <label>Purpose</label>
          <select id="purpose">
            <option>Test payment</option>
            <option>Listing boost</option>
            <option>Verification</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Memo (optional)</label>
        <input id="memo" placeholder="e.g., QA check from Paynekilla" />
      </div>

      <button id="pay-btn" type="button">⚡ Send Test Payment</button>
      <div class="muted">You’ll approve this payment in the Pi Browser. No real Pi leaves Testnet.</div>
    </div>
  </div>

  <!-- Pi SDK + wiring -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const btn = document.getElementById('pay-btn');
    if (!btn) { console.error('pay-btn not found'); return; }
    btn.type = 'button';

    // Smoke test so we know clicks are binding
    btn.addEventListener('click', () => console.log('pay click fired (smoke test)'));

    const Pi = window.Pi;
    if (!Pi) { console.error('Pi SDK not loaded'); return; }

    // TESTNET
    Pi.init({ version: "2.0", sandbox: true });

    // Must be authenticated with payments scope
    try {
      await Pi.authenticate(['payments'], (p)=>console.log('incomplete payment:', p));
      console.log('Pi auth OK');
    } catch (e) {
      console.error('Pi auth failed:', e);
    }

    btn.addEventListener('click', async () => {
      try {
        console.log('starting createPayment');
        const amount = Number(document.getElementById('amount').value || '0.001');
        const memo   = document.getElementById('memo').value || 'QA test';
        await Pi.createPayment({ amount, memo, metadata:{} }, {
          onReadyForServerApproval: async (paymentId) => {
            console.log('approve ->', paymentId);
            await fetch('/api/pi/approve', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            console.log('complete ->', paymentId, txid);
            await fetch('/api/pi/complete', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: (id)=>console.warn('payment canceled', id),
          onError:  (err,id)=>console.error('Pi SDK error', err, id),
        });
        alert('Payment flow finished ✅');
      } catch (e) {
        console.error('caught error', e);
        alert('Payment failed ❌ — open console for details');
      }
    });
  });
  </script>
</body>
</html>
