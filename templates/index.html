<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade Haven â€¢ Testnet Payment</title>
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f7f7fb;margin:0;padding:0}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:48px;line-height:1.1;margin:0 0 8px}
    p{color:#555}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:24px;margin-top:24px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:14px;color:#444;margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:12px;font-size:16px}
    button{width:100%;padding:14px 18px;border:0;border-radius:12px;background:#6b2ae6;color:#fff;font-weight:700;font-size:16px;margin-top:14px}
    .muted{color:#777;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thrive with Pi Across Africa & Beyond</h1>
    <p>Do a quick <b>test payment</b> to confirm your app is wired to the Pi Network SDK.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Amount (Ï€)</label>
          <input id="amount" value="0.001" inputmode="decimal" />
        </div>
        <div>
          <label>Purpose</label>
          <select id="purpose">
            <option>Test payment</option>
            <option>Listing boost</option>
            <option>Verification</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Memo (optional)</label>
        <input id="memo" placeholder="e.g., QA check from Paynekilla" />
      </div>

      <button id="pay-btn" type="button">âš¡ Send Test Payment</button>
      <div class="muted">Works only in Pi Browser â€¢ Safe test: no mainnet funds are used</div>
    </div>
  </div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // on-screen status (no console needed)
    const statusEl = document.createElement('div');
    statusEl.style.cssText = "position:fixed;bottom:10px;left:10px;background:#111;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;opacity:.9;z-index:9999";
    document.body.appendChild(statusEl);
    const say = (m)=>{ statusEl.textContent = m; };

    const btn = document.getElementById('pay-btn');
    if (!btn) { alert('âŒ pay-btn not found'); return; }
    btn.type = 'button';

    // prove the click is wired
    btn.addEventListener('click', () => { console.log('click'); alert('âœ… Button click detected'); });

    const Pi = window.Pi;
    if (!Pi) { alert('âŒ Pi SDK not loaded. Open this in Pi Browser.'); return; }

    // TESTNET
    Pi.init({ version: "2.0", sandbox: true });
    say('Pi SDK initialized (testnet)');

    // authenticate early
    try {
      const me = await Pi.authenticate(['payments'], (p)=>console.log('incomplete payment:', p));
      say('ðŸ” Auth OK as ' + (me?.username || 'user'));
    } catch (e) {
      alert('âŒ Auth failed: ' + (e?.message || e));
      say('Auth failed');
      return;
    }

    // payment flow
    btn.addEventListener('click', async () => {
      try {
        alert('ðŸ“¡ Starting paymentâ€¦');
        say('Starting createPayment');

        const amount = Number((document.getElementById('amount').value || '0.001'));
        const memo   = (document.getElementById('memo').value || 'QA test');

        await Pi.createPayment({ amount, memo, metadata:{} }, {
          onReadyForServerApproval: async (paymentId) => {
            say('Approving on serverâ€¦ ' + paymentId);
            console.log('approve ->', paymentId);
            await fetch('/api/pi/approve', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId })
            });
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            say('Completing on serverâ€¦');
            console.log('complete ->', paymentId, txid);
            await fetch('/api/pi/complete', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ paymentId, txid })
            });
          },
          onCancel: (id)=>{ alert('âŒ Canceled'); say('Canceled'); },
          onError:  (err,id)=>{ alert('âš ï¸ Pi error: ' + err); say('Pi error'); },
        });

        alert('âœ… Payment flow finished');
        say('Done');
      } catch (e) {
        alert('âŒ Payment failed: ' + (e?.message || e));
        say('Payment failed');
      }
    });
  });

  // catch silent JS errors
  window.addEventListener('error', e => alert('JS error: ' + e.message));
  </script>
</body>
</html>
